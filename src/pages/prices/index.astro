---
import Layout from "../../layouts/Layout.astro";
import AnalyticsRuntime from "../../components/AnalyticsRuntime.astro";
import Footer from "../../components/Footer.astro";
import skus from "../../data/skus.json";
import { safeBreak } from "../../lib/safe-break";
const BASE_URL = import.meta.env.BASE_URL;

let data;
let sourceStatus = "fail";
try {
  const url = new URL(
    BASE_URL + "data/prices/today.json",
    Astro.site
  );
  const res = await fetch(url);
  if (res.ok) {
    data = await res.json();
  }
} catch {}
if (data?.sourceStatus) {
  const values = Object.values(data.sourceStatus);
  if (values.every(v => v === "ok")) {
    sourceStatus = "ok";
  } else if (values.every(v => v === "fail")) {
    sourceStatus = "fail";
  } else {
    sourceStatus = "partial";
  }
}
const skuMap = Object.fromEntries(skus.map(s => [s.id, s]));
---
<Layout title="今日の最安“候補”">
  <div class="wrap">
      {sourceStatus !== "ok" && (
        <div role="status" aria-live="polite" class="notice--warn" data-source-status={sourceStatus}>
          ⚠︎ {sourceStatus === "partial"
            ? "一部のデータが取得できませんでした。表示は最新の取得分です。"
            : "一部ソースの取得に失敗しました。別ソースまたは前回データで表示しています。"}
        </div>
      )}
      <a href="./" class="small">← トップ</a>
      <h1 set:html={safeBreak("今日の最安“候補”")}></h1>
      <p class="small jp-copy">対象カテゴリから毎日、自動で候補を抽出し、価格とポイント相当を目安に並べ替えています。</p>
      <p class="small jp-copy">表示価格は取得時点の参考値です。購入前に必ずリンク先の最新情報をご確認ください。</p>
      {data ? (
        <>
          <p class="small jp-copy">取得日時: {new Date(data.updatedAt).toLocaleString('ja-JP')}</p>
          {data.sourceStatus && <p class="small jp-copy">対象ストア: 楽天市場、Yahoo!ショッピング</p>}
          <ul>
            {data.items.map((it, index) => {
              const analyticsPayload = JSON.stringify({
                sku: it.skuId,
                rank: index + 1,
                from_page: "/prices/",
              });
              return (
                <li>
                  <a
                    href={`prices/${it.skuId}/`}
                    data-analytics="sku_card_click"
                    data-analytics-payload={analyticsPayload}
                  >
                    {skuMap[it.skuId]?.q ?? it.skuId}
                  </a>
                  : {it.bestPrice}円 ({it.bestShop})
                </li>
              );
            })}
          </ul>
        </>
      ) : (
        <p>データ少</p>
      )}
  </div>
  <Footer />
  <AnalyticsRuntime />
</Layout>
