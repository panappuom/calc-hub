---
import "../../styles/global.css";
import Footer from "../../components/Footer.astro";
import skus from "../../data/skus.json";

let data;
let rakutenData;
let yahooData;
try {
  const url = new URL(
    import.meta.env.BASE_URL + "data/prices/today.json",
    Astro.site
  );
  const res = await fetch(url);
  if (res.ok) {
    data = await res.json();
  }
} catch {}
try {
  const url = new URL(
    import.meta.env.BASE_URL + "data/prices/today.rakuten.json",
    Astro.site
  );
  const res = await fetch(url);
  if (res.ok) {
    rakutenData = await res.json();
  }
} catch {}
try {
  const url = new URL(
    import.meta.env.BASE_URL + "data/prices/today.yahoo.json",
    Astro.site
  );
  const res = await fetch(url);
  if (res.ok) {
    yahooData = await res.json();
  }
} catch {}
const { sku } = Astro.params;
const skuInfo = skus.find(s => s.id === sku);
const priceInfo = data?.items?.find(i => i.skuId === sku);
const list = priceInfo?.list ? [...priceInfo.list].sort((a, b) => a.price - b.price) : [];
const rakutenList = rakutenData?.items?.find(i => i.skuId === sku)?.list?.sort((a, b) => a.price - b.price) ?? [];
const yahooList = yahooData?.items?.find(i => i.skuId === sku)?.list?.sort((a, b) => a.price - b.price) ?? [];
const allList = [
  ...rakutenList.map(it => ({ ...it, store: '楽天' })),
  ...yahooList.map(it => ({ ...it, store: 'Yahoo' }))
].sort((a, b) => a.price - b.price);
const hasAllPoints = allList.some(it => it.pointRate);
const sections = [
  { name: 'Rakuten', key: 'rakuten', list: rakutenList, status: data?.sourceStatus?.rakuten ?? 'fail', hasPoints: rakutenList.some(it => it.pointRate) },
  { name: 'Yahoo', key: 'yahoo', list: yahooList, status: data?.sourceStatus?.yahoo ?? 'fail', hasPoints: yahooList.some(it => it.pointRate) }
];
const statusMessages = {
  partial: 'このソースの一部データが取得できませんでした。表示は最新の取得分です。',
  fail: 'このソースの取得に失敗しました。別ソースまたは前回データで表示しています。'
};
const bestToday = list.length
  ? list.reduce((min, it) => (it.price < min.price ? it : min), list[0])
  : null;
let bestRecommended = priceInfo?.bestRecommended ?? null;
if (!bestRecommended && list.length && skuInfo?.brandHints?.length) {
  const cand = list.filter(it => {
    const title = it.title?.toLowerCase() ?? '';
    return skuInfo.brandHints.some(b => title.includes(b.toLowerCase()));
  });
  if (cand.length) {
    bestRecommended = cand.reduce((min, it) => (it.price < min.price ? it : min), cand[0]);
  }
}
function formatCurrency(value) {
  const num = Number(value);
  if (!Number.isFinite(num)) return '';
  return `${Math.round(num).toLocaleString('ja-JP')}円`;
}

function formatPrice(it) {
  if (!it) return '';
  return formatCurrency(it.price);
}

function formatSummary(it) {
  if (!it) return '';
  if (it.pointRate) {
    const eff = Math.floor(it.price * (100 - it.pointRate) / 100);
    return `${formatPrice(it)}（ポイント${it.pointRate}%で実質${formatCurrency(eff)}）`;
  }
  return formatPrice(it);
}

function getShopLinkDescription(name) {
  if (!name) {
    return 'ショップで商品の詳細を確認できます（新しいタブで開きます）';
  }
  return `${name}で商品の詳細を確認できます（新しいタブで開きます）`;
}

export function getStaticPaths() {
  return skus.map(s => ({ params: { sku: s.id } }));
}
---
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <base href={import.meta.env.BASE_URL} />
    <title>{skuInfo ? skuInfo.q : sku} – 価格一覧</title>
  </head>
  <body>
    <div class="wrap">
        <a href="./" class="small">← トップ</a>
      <h1>{skuInfo ? skuInfo.q : sku} – 価格一覧</h1>
      <p>ショップ別の価格を一覧しています。並び順は目安（価格）です。</p>
      <p class="small">
        {data
          ? `取得日時: ${new Date(data.updatedAt).toLocaleString('ja-JP')}`
          : 'データ少'}
      </p>
      {skuInfo && (
        <div>
          <h2>仕様</h2>
          <ul>
            {skuInfo.filters && <li>フィルタ: {skuInfo.filters.join(', ')}</li>}
            {skuInfo.brandHints && <li>ブランド候補: {skuInfo.brandHints.join(', ')}</li>}
          </ul>
        </div>
      )}
      {priceInfo ? (
        <>
          <div>
            <h2>最安情報</h2>
            <ul>
              <li>今日の最安: {bestToday ? `${formatSummary(bestToday)} (${bestToday.shopName})` : 'データ少'}</li>
              {skuInfo?.brandHints?.length && (
                <li>
                  推奨安（ブランド一致優先）:
                  {bestRecommended
                    ? `${formatSummary(bestRecommended)} (${bestRecommended.shopName})`
                    : '該当なし'}
                </li>
              )}
            </ul>
          </div>
          <div class="tabs">
            <button type="button" data-tab="all" class="active">全ストア</button>
            <button type="button" data-tab="rakuten">楽天のみ</button>
            <button type="button" data-tab="yahoo">Yahooのみ</button>
          </div>
          <div class="price-section tab-content" data-tab="all">
            <h2>全ストア</h2>
            {allList.length ? (
              <>
                {hasAllPoints && <button class="sort-toggle">実質価格順に切替</button>}
                <table class="price-table">
                  <thead class="sr-only">
                    <tr>
                      <th id="col-all-store" scope="col">ストア</th>
                      <th id="col-all-shop" scope="col">ショップ</th>
                      <th id="col-all-price" scope="col" data-column="price">価格</th>
                      <th id="col-all-point" scope="col" data-column="points">ポイント</th>
                      <th id="col-all-eff" scope="col" data-column="effective">実質価格<br/><span class="small">（ポイント込み）</span></th>
                    </tr>
                  </thead>
                  <tbody>
                    {allList.map(it => {
                      const eff = Math.floor(it.price * (100 - (it.pointRate ?? 0)) / 100);
                      return (
                        <tr data-price={it.price} data-eff={eff}>
                          <td headers="col-all-store" data-label="ストア" data-cell="store">{it.store}</td>
                          <td headers="col-all-shop" data-label="ショップ" data-cell="shop">
                            <span class="shop-name" title={it.shopName}>
                              {it.shopName}
                            </span>
                            <a
                              href={it.itemUrl}
                              target="_blank"
                              rel="nofollow noopener"
                              title={getShopLinkDescription(it.shopName)}
                              aria-label={getShopLinkDescription(it.shopName)}
                            >
                              ショップで確認
                              <span aria-hidden="true" class="external-link-icon">↗</span>
                            </a>
                          </td>
                          <td headers="col-all-price" data-label="価格" data-cell="price">{formatPrice(it)}</td>
                          <td headers="col-all-point" data-label="ポイント" data-cell="points">{it.pointRate ? `${it.pointRate}%` : '-'}</td>
                          <td headers="col-all-eff" data-label="実質価格" data-cell="effective">{formatCurrency(eff)}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </>
            ) : (
              <p>データ少</p>
            )}
          </div>
          {sections.map(sec => (
            <div class="price-section tab-content" data-tab={sec.key} data-source-status={sec.status} style="display:none">
              <h2>
                {sec.name}
                {sec.status !== 'ok' && (
                  <span class="status-icon--warn" aria-label={statusMessages[sec.status]} title={statusMessages[sec.status]}>⚠️</span>
                )}
              </h2>
              {sec.list.length ? (
                <>
                  {sec.hasPoints && <button class="sort-toggle">実質価格順に切替</button>}
                  <table class="price-table">
                    <thead class="sr-only">
                      <tr>
                        <th id={`col-${sec.key}-shop`} scope="col">ショップ</th>
                        <th id={`col-${sec.key}-price`} scope="col" data-column="price">価格</th>
                        <th id={`col-${sec.key}-point`} scope="col" data-column="points">ポイント</th>
                        <th id={`col-${sec.key}-eff`} scope="col" data-column="effective">実質価格<br/><span class="small">（ポイント込み）</span></th>
                      </tr>
                    </thead>
                    <tbody>
                      {sec.list.map(it => {
                        const eff = Math.floor(it.price * (100 - (it.pointRate ?? 0)) / 100);
                        return (
                          <tr data-price={it.price} data-eff={eff}>
                            <td headers={`col-${sec.key}-shop`} data-label="ショップ" data-cell="shop">
                              <span class="shop-name" title={it.shopName}>
                                {it.shopName}
                              </span>
                              <a
                                href={it.itemUrl}
                                target="_blank"
                                rel="nofollow noopener"
                                title={getShopLinkDescription(it.shopName)}
                                aria-label={getShopLinkDescription(it.shopName)}
                              >
                                ショップで確認
                                <span aria-hidden="true" class="external-link-icon">↗</span>
                              </a>
                            </td>
                            <td headers={`col-${sec.key}-price`} data-label="価格" data-cell="price">{formatPrice(it)}</td>
                            <td headers={`col-${sec.key}-point`} data-label="ポイント" data-cell="points">{it.pointRate ? `${it.pointRate}%` : '-'}</td>
                            <td headers={`col-${sec.key}-eff`} data-label="実質価格" data-cell="effective">{formatCurrency(eff)}</td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </>
              ) : (
                <p>データ少</p>
              )}
            </div>
          ))}
          <p class="small">※実質価格はポイント考慮の試算です。</p>
          <p class="small">価格・在庫は常に変動します。購入前にリンク先で最新情報をご確認ください。</p>
          <h2>価格推移 (30日)</h2>
          <div class="chart-container">
            <canvas id="chart" data-sku={sku}></canvas>
          </div>
          <p id="chart-msg" class="small"></p>
          <p class="small">過去データはAPI仕様・収集失敗で欠損する場合があります。</p>
          <script>
            const tabButtons = document.querySelectorAll('.tabs button');
            const tabSections = document.querySelectorAll('.tab-content');
            tabButtons.forEach(btn => {
              btn.addEventListener('click', () => {
                const target = btn.dataset.tab;
                tabButtons.forEach(b => b.classList.toggle('active', b === btn));
                tabSections.forEach(sec => {
                  sec.style.display = sec.dataset.tab === target ? '' : 'none';
                });
              });
            });
          </script>
          <script>
            document.querySelectorAll('.price-section').forEach(sec => {
              const toggle = sec.querySelector('.sort-toggle');
              const tbody = sec.querySelector('tbody');
              if (!toggle || !tbody) return;
              const rows = Array.from(tbody.querySelectorAll('tr'));
              let byEff = false;
              function sortRows() {
                rows
                  .sort((a, b) => {
                    const k = byEff ? 'eff' : 'price';
                    return Number(a.dataset[k]) - Number(b.dataset[k]);
                  })
                  .forEach(r => tbody.appendChild(r));
              }
              toggle.addEventListener('click', () => {
                byEff = !byEff;
                sortRows();
                toggle.textContent = byEff ? '価格順に切替' : '実質価格順に切替';
              });
            });
          </script>
          <script>
            const canvas = document.getElementById('chart');
            const msg = document.getElementById('chart-msg');

            if (canvas && msg) {
              const sku = canvas.dataset.sku;
              const base = document.baseURI;
              let chartData = null;

              function renderChart() {
                if (!chartData || chartData.length < 2) return;
                const rect = canvas.getBoundingClientRect();
                const width = rect.width;
                const height = rect.height;
                if (width === 0 || height === 0) return;
                const dpr = window.devicePixelRatio || 1;
                canvas.width = Math.round(width * dpr);
                canvas.height = Math.round(height * dpr);
                const ctx = canvas.getContext('2d');
                if (!ctx) return;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const prices = chartData.map(d => d.price);
                const min = Math.min(...prices);
                const max = Math.max(...prices);
                const range = max - min || 1;
                ctx.beginPath();
                chartData.forEach((p, i) => {
                  const x = i * (canvas.width / (chartData.length - 1));
                  const y = canvas.height - (p.price - min) / range * canvas.height;
                  if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.strokeStyle = '#0070f3';
                ctx.lineWidth = Math.max(1, dpr);
                ctx.stroke();
              }

              function handleResize() {
                if (!chartData || chartData.length < 2) return;
                renderChart();
              }

              window.addEventListener('resize', handleResize);

              fetch(`${base}data/price-history/${sku}.json?t=${Date.now()}`)
                .then(r => r.json())
                .then(hist => {
                  const list = Array.isArray(hist) ? hist : Object.values(hist).find(Array.isArray) || [];
                  const filtered = list.filter(d => Number.isFinite(d.price)).slice(-30);
                  if (filtered.length < 2) {
                    canvas.style.display = 'none';
                    msg.textContent = 'データ少';
                    return;
                  }
                  chartData = filtered;
                  canvas.style.display = '';
                  msg.textContent = '';
                  renderChart();
                })
                .catch(() => {
                  canvas.style.display = 'none';
                  msg.textContent = 'データ少';
                });
            }
          </script>
        </>
      ) : (
        <p>データ少</p>
      )}
    </div>
    <Footer />
  </body>
</html>
